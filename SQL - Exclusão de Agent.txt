--select * from AGENTE WHERE AGECOD in ('002519', '001137')
--select * from DEFINICAO WHERE AGECOD in ('002519', '001137')
BEGIN TRY
  BEGIN TRAN
    ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    PRINT 'Aguarde... Este procedimento deverá ser demorado...'
    declare 
    @AGENTE_ORI char(6),
    @AGENTE_DEST char(6)
    
    set @AGENTE_ORI = '002519'
    set @AGENTE_DEST = '001137'
    
    ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    PRINT 'Ajustando chaves'
    alter table ITEM_RESUMO_CARTAO_CREDITO drop Reference_379  
    alter table ITEM_RESUMO_CARTAO_CREDITO drop Reference_923
    alter table TITULO_RECEBER_LIQ drop FK_TITULO_RECEBER_LIQ_CARTCREDLANC
    alter table FATURA_SAIDA_TIPO_DOCUMENTO drop Reference_953
    alter table GRUPO_TITULO_RECEBER_LIQ drop Reference_1510
    
    ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    PRINT 'Migrando movimentações do agente de origem para o auxiliar de origem'
    UPDATE DEFINICAO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    if not exists (select * from AGENTE_ENDERECO where AGECOD = @AGENTE_DEST) 
      UPDATE AGENTE_ENDERECO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    else
      delete from AGENTE_ENDERECO WHERE AGECOD = @AGENTE_ORI
    
    UPDATE AGENTE_NEGATIVADO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE BANCO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE BANDEIRA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE BORDERO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE CHEQUE SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE CHEQUE_RECEBER SET AGECODEMI = @AGENTE_DEST WHERE AGECODEMI = @AGENTE_ORI
    UPDATE CLIENTE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE COMISSAO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE CONFIRMACAO_TRANSFERENCIA SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE CARTAO_CREDITO_LANCAMENTO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE ITEM_RESUMO_CARTAO_CREDITO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE TITULO_RECEBER_LIQ SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE GRUPO_TITULO_RECEBER_LIQ SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE FATURA_SAIDA_TIPO_DOCUMENTO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE CONTA_CORRENTE_LANCAMENTO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE CONTATO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE CONTRATO_FATURA_HARDWARE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE CONTRATO_FATURA_SOFTWARE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE DOCUMENTO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE DOCUMENTO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE DOCUMENTO SET AGECODRECOTR = @AGENTE_DEST WHERE AGECODRECOTR = @AGENTE_ORI
    UPDATE DOCUMENTO SET AGECODTRP = @AGENTE_DEST WHERE AGECODTRP = @AGENTE_ORI
    UPDATE ESTATISTICA_MOVIMENTACAO_ENTRADA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE FATURA_ENTRADA SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FATURA_HARDWARE SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FATURA_RETENCAO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FATURA_SAIDA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE FATURA_SAIDA SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FATURA_SOFTWARE SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FATURAMENTO_VENDA SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FINALIZADORA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE FORNECEDOR SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE FORNECEDOR SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE FUNCIONARIO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE ITEM_CONTRATO_FATURA_HARDWARE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE ITEM_CONTRATO_FATURA_SOFTWARE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE ITEM_FATURA_HARDWARE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE ITEM_FATURA_SOFTWARE SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE LICENCA SET AGECODFAT = @AGENTE_DEST WHERE AGECODFAT = @AGENTE_ORI
    UPDATE LOJA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE LOJA SET AGECODPDR = @AGENTE_DEST WHERE AGECODPDR = @AGENTE_ORI
    UPDATE MEIO_AUTORIZADOR SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE PAGAMENTO_ANTECIPADO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE PAGAMENTO_ANTECIPADO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE PAGAMENTO_PDV SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE PEDIDO_VENDA SET AGECODFAT = @AGENTE_DEST WHERE AGECODFAT = @AGENTE_ORI
    UPDATE PEDIDO_VENDA_ENTREGA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE PEDIDO_VENDA_ENTREGA SET AGECODTRP = @AGENTE_DEST WHERE AGECODTRP = @AGENTE_ORI
    UPDATE PLANO_CONTAS_LANCAMENTO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE RECEBIMENTO_ANTECIPADO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE RECEBIMENTO_ANTECIPADO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE REGISTRO_OCORRENCIA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE RENEGOCIACAO_RECEBER SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE RENEGOCIACAO_RECEBER SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE REQUISICAO_PRODUCAO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE REVENDA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE REVENDA SET AGECODFAT = @AGENTE_DEST WHERE AGECODFAT = @AGENTE_ORI
    UPDATE EXTRATO_PAGAMENTO_ANTECIPADO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE EXTRATO_RECEBIMENTO_ANTECIPADO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    update SALDO_PAGAMENTO_ANTECIPADO set SLDPAGANTVLR = SLDPAGANTVLR + (select SLDPAGANTVLR from SALDO_PAGAMENTO_ANTECIPADO S_ORI where S_ORI.AGECOD = @AGENTE_ORI) from SALDO_PAGAMENTO_ANTECIPADO S where S.AGECOD = @AGENTE_DEST
    update SALDO_PAGAMENTO_ANTECIPADO set SLDPAGANTVLR = SLDPAGANTVLR + (select SLDPAGANTVLR from SALDO_PAGAMENTO_ANTECIPADO S_ORI where S_ORI.AGECOD = @AGENTE_ORI) from SALDO_PAGAMENTO_ANTECIPADO S where S.AGECOD = @AGENTE_DEST
    UPDATE TITULO_FINANCEIRO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE TITULO_FINANCEIRO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE TITULO_PAGAR_ESTORNO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE TITULO_PAGAR_ESTORNO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE TITULO_RECEBER_ESTORNO SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
    UPDATE TITULO_RECEBER_ESTORNO SET AGECODREC = @AGENTE_DEST WHERE AGECODREC = @AGENTE_ORI
    UPDATE TRANSPORTADORA SET AGECOD = @AGENTE_DEST WHERE AGECOD = @AGENTE_ORI
        
    ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    PRINT 'Ajustando chaves...'
    ALTER TABLE [dbo].[ITEM_RESUMO_CARTAO_CREDITO]  WITH NOCHECK ADD  CONSTRAINT [Reference_379] FOREIGN KEY([AGECOD], [ESPCOD], [CCLCOD])
      REFERENCES [dbo].[CARTAO_CREDITO_LANCAMENTO] ([AGECOD], [ESPCOD], [CCLCOD]) ON DELETE CASCADE
        
    ALTER TABLE [dbo].[ITEM_RESUMO_CARTAO_CREDITO]  WITH NOCHECK ADD  CONSTRAINT [Reference_923] FOREIGN KEY([RSMCRTCOD], [AGECOD], [ESPCOD])
      REFERENCES [dbo].[RESUMO_CARTAO_CREDITO] ([RSMCRTCOD], [AGECOD], [ESPCOD]) ON DELETE CASCADE
    ALTER TABLE [dbo].[TITULO_RECEBER_LIQ]  WITH NOCHECK ADD  CONSTRAINT [FK_TITULO_RECEBER_LIQ_CARTCREDLANC] FOREIGN KEY([AGECOD], [ESPCOD], [CCRCOD])
      REFERENCES [dbo].[CARTAO_CREDITO_LANCAMENTO] ([AGECOD], [ESPCOD], [CCLCOD]) ON DELETE CASCADE
        
    ALTER TABLE [dbo].[FATURA_SAIDA_TIPO_DOCUMENTO]  WITH NOCHECK ADD  CONSTRAINT [Reference_953] FOREIGN KEY([AGECOD], [ESPCOD], [CCRCOD])
      REFERENCES [dbo].[CARTAO_CREDITO_LANCAMENTO] ([AGECOD], [ESPCOD], [CCLCOD]) ON DELETE CASCADE
      
    ALTER TABLE [dbo].[GRUPO_TITULO_RECEBER_LIQ]  WITH NOCHECK ADD  CONSTRAINT [Reference_1510] FOREIGN KEY([AGECOD], [ESPCOD], [CCRCOD])
      REFERENCES [dbo].[CARTAO_CREDITO_LANCAMENTO] ([AGECOD], [ESPCOD], [CCLCOD])
    ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    
    delete from AGENTE where AGECOD = @AGENTE_ORI
    --COMMIT
    PRINT 'Migração finalizada com sucesso...'
  END TRY
    BEGIN CATCH
      PRINT 'Erro na migração dos agentes...'
      ROLLBACK
      SELECT ERROR_LINE(), ERROR_MESSAGE()
END CATCH

/*
Violation of PRIMARY KEY constraint 'PK_CARTAO_CREDITO_LANCAMENTO'. Cannot insert duplicate key in object 'dbo.CARTAO_CREDITO_LANCAMENTO'. The duplicate key value is (001137, 900, 1).
*/